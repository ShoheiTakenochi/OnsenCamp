require "net/http"
require "json"
require "open-uri"
require "fileutils"

namespace :fetch do
  desc "Fetch and save campsites from Google Places API (New)"
  task campsites: :environment do
    api_key = ENV["GOOGLE_MAPS_API_KEY"]

    # 都道府県の座標と名前
    PREFECTURES = {
      "北海道1"=>"41.385,139.8836",
      "北海道2"=>"41.385,140.3336",
      "北海道3"=>"41.385,140.7836",
      "北海道4"=>"41.385,141.2336",
      "北海道5"=>"41.385,141.6836",
      "北海道6"=>"41.385,142.1336",
      "北海道7"=>"41.385,142.5836",
      "北海道8"=>"41.385,143.0336",
      "北海道9"=>"41.385,143.4836",
      "北海道10"=>"41.385,143.9336",
      "北海道11"=>"41.385,144.3836",
      "北海道12"=>"41.385,144.8336",
      "北海道13"=>"41.835,139.8836",
      "北海道14"=>"41.835,140.3336",
      "北海道15"=>"41.835,140.7836",
      "北海道16"=>"41.835,141.2336",
      "北海道17"=>"41.835,141.6836",
      "北海道18"=>"41.835,142.1336",
      "北海道19"=>"41.835,142.5836",
      "北海道20"=>"41.835,143.0336",
      "北海道21"=>"41.835,143.4836",
      "北海道22"=>"41.835,143.9336",
      "北海道23"=>"41.835,144.3836",
      "北海道24"=>"41.835,144.8336",
      "北海道25"=>"42.285,139.8836",
      "北海道26"=>"42.285,140.3336",
      "北海道27"=>"42.285,140.7836",
      "北海道28"=>"42.285,141.2336",
      "北海道29"=>"42.285,141.6836",
      "北海道30"=>"42.285,142.1336",
      "北海道31"=>"42.285,142.5836",
      "北海道32"=>"42.285,143.0336",
      "北海道33"=>"42.285,143.4836",
      "北海道34"=>"42.285,143.9336",
      "北海道35"=>"42.285,144.3836",
      "北海道36"=>"42.285,144.8336",
      "北海道37"=>"42.735,139.8836",
      "北海道38"=>"42.735,140.3336",
      "北海道39"=>"42.735,140.7836",
      "北海道40"=>"42.735,141.2336",
      "北海道41"=>"42.735,141.6836",
      "北海道42"=>"42.735,142.1336",
      "北海道43"=>"42.735,142.5836",
      "北海道44"=>"42.735,143.0336",
      "北海道45"=>"42.735,143.4836",
      "北海道46"=>"42.735,143.9336",
      "北海道47"=>"42.735,144.3836",
      "北海道48"=>"42.735,144.8336",
      "北海道49"=>"43.185,139.8836",
      "北海道50"=>"43.185,140.3336",
      "北海道51"=>"43.185,140.7836",
      "北海道52"=>"43.185,141.2336",
      "北海道53"=>"43.185,141.6836",
      "北海道54"=>"43.185,142.1336",
      "北海道55"=>"43.185,142.5836",
      "北海道56"=>"43.185,143.0336",
      "北海道57"=>"43.185,143.4836",
      "北海道58"=>"43.185,143.9336",
      "北海道59"=>"43.185,144.3836",
      "北海道60"=>"43.185,144.8336",
      "北海道61"=>"43.635,139.8836",
      "北海道62"=>"43.635,140.3336",
      "北海道63"=>"43.635,140.7836",
      "北海道64"=>"43.635,141.2336",
      "北海道65"=>"43.635,141.6836",
      "北海道66"=>"43.635,142.1336",
      "北海道67"=>"43.635,142.5836",
      "北海道68"=>"43.635,143.0336",
      "北海道69"=>"43.635,143.4836",
      "北海道70"=>"43.635,143.9336",
      "北海道71"=>"43.635,144.3836",
      "北海道72"=>"43.635,144.8336",
      "北海道73"=>"44.085,139.8836",
      "北海道74"=>"44.085,140.3336",
      "北海道75"=>"44.085,140.7836",
      "北海道76"=>"44.085,141.2336",
      "北海道77"=>"44.085,141.6836",
      "北海道78"=>"44.085,142.1336",
      "北海道79"=>"44.085,142.5836",
      "北海道80"=>"44.085,143.0336",
      "北海道81"=>"44.085,143.4836",
      "北海道82"=>"44.085,143.9336",
      "北海道83"=>"44.085,144.3836",
      "北海道84"=>"44.085,144.8336",
      "北海道85"=>"44.535,139.8836",
      "北海道86"=>"44.535,140.3336",
      "北海道87"=>"44.535,140.7836",
      "北海道88"=>"44.535,141.2336",
      "北海道89"=>"44.535,141.6836",
      "北海道90"=>"44.535,142.1336",
      "北海道91"=>"44.535,142.5836",
      "北海道92"=>"44.535,143.0336",
      "北海道93"=>"44.535,143.4836",
      "北海道94"=>"44.535,143.9336",
      "北海道95"=>"44.535,144.3836",
      "北海道96"=>"44.535,144.8336",
      "北海道97"=>"44.985,139.8836",
      "北海道98"=>"44.985,140.3336",
      "北海道99"=>"44.985,140.7836",
      "北海道100"=>"44.985,141.2336",
      "北海道101"=>"44.985,141.6836",
      "北海道102"=>"44.985,142.1336",
      "北海道103"=>"44.985,142.5836",
      "北海道104"=>"44.985,143.0336",
      "北海道105"=>"44.985,143.4836",
      "北海道106"=>"44.985,143.9336",
      "北海道107"=>"44.985,144.3836",
      "北海道108"=>"44.985,144.8336",
      "北海道109"=>"45.435,139.8836",
      "北海道110"=>"45.435,140.3336",
      "北海道111"=>"45.435,140.7836",
      "北海道112"=>"45.435,141.2336",
      "北海道113"=>"45.435,141.6836",
      "北海道114"=>"45.435,142.1336",
      "北海道115"=>"45.435,142.5836",
      "北海道116"=>"45.435,143.0336",
      "北海道117"=>"45.435,143.4836",
      "北海道118"=>"45.435,143.9336",
      "北海道119"=>"45.435,144.3836",
      "北海道120"=>"45.435,144.8336",
      "青森県1"=>"40.236,139.4602",
      "青森県2"=>"40.236,139.9102",
      "青森県3"=>"40.236,140.3602",
      "青森県4"=>"40.236,140.8102",
      "青森県5"=>"40.236,141.2602",
      "青森県6"=>"40.686,139.4602",
      "青森県7"=>"40.686,139.9102",
      "青森県8"=>"40.686,140.3602",
      "青森県9"=>"40.686,140.8102",
      "青森県10"=>"40.686,141.2602",
      "青森県11"=>"41.136,139.4602",
      "青森県12"=>"41.136,139.9102",
      "青森県13"=>"41.136,140.3602",
      "青森県14"=>"41.136,140.8102",
      "青森県15"=>"41.136,141.2602",
      "岩手県1"=>"38.892,140.4937",
      "岩手県2"=>"38.892,140.9437",
      "岩手県3"=>"38.892,141.3937",
      "岩手県4"=>"38.892,141.8437",
      "岩手県5"=>"39.342,140.4937",
      "岩手県6"=>"39.342,140.9437",
      "岩手県7"=>"39.342,141.3937",
      "岩手県8"=>"39.342,141.8437",
      "岩手県9"=>"39.792,140.4937",
      "岩手県10"=>"39.792,140.9437",
      "岩手県11"=>"39.792,141.3937",
      "岩手県12"=>"39.792,141.8437",
      "岩手県13"=>"40.242,140.4937",
      "岩手県14"=>"40.242,140.9437",
      "岩手県15"=>"40.242,141.3937",
      "岩手県16"=>"40.242,141.8437",
      "宮城県1"=>"37.879,140.3747",
      "宮城県2"=>"37.879,140.8247",
      "宮城県3"=>"37.879,141.2747",
      "宮城県4"=>"38.329,140.3747",
      "宮城県5"=>"38.329,140.8247",
      "宮城県6"=>"38.329,141.2747",
      "宮城県7"=>"38.779,140.3747",
      "宮城県8"=>"38.779,140.8247",
      "宮城県9"=>"38.779,141.2747",
      "秋田県1"=>"39.043,139.5740",
      "秋田県2"=>"39.043,140.0240",
      "秋田県3"=>"39.043,140.4740",
      "秋田県4"=>"39.493,139.5740",
      "秋田県5"=>"39.493,140.0240",
      "秋田県6"=>"39.493,140.4740",
      "秋田県7"=>"39.943,139.5740",
      "秋田県8"=>"39.943,140.0240",
      "秋田県9"=>"39.943,140.4740",
      "秋田県10"=>"40.393,139.5740",
      "秋田県11"=>"40.393,140.0240",
      "秋田県12"=>"40.393,140.4740",
      "山形県1"=>"37.728,139.4660",
      "山形県2"=>"37.728,139.9160",
      "山形県3"=>"37.728,140.3660",
      "山形県4"=>"37.728,140.8160",
      "山形県5"=>"38.178,139.4660",
      "山形県6"=>"38.178,139.9160",
      "山形県7"=>"38.178,140.3660",
      "山形県8"=>"38.178,140.8160",
      "山形県9"=>"38.628,139.4660",
      "山形県10"=>"38.628,139.9160",
      "山形県11"=>"38.628,140.3660",
      "山形県12"=>"38.628,140.8160",
      "山形県13"=>"39.078,139.4660",
      "山形県14"=>"39.078,139.9160",
      "山形県15"=>"39.078,140.3660",
      "山形県16"=>"39.078,140.8160",
      "福島県1"=>"36.734,139.3886",
      "福島県2"=>"36.734,139.8386",
      "福島県3"=>"36.734,140.2886",
      "福島県4"=>"36.734,140.7386",
      "福島県5"=>"37.184,139.3886",
      "福島県6"=>"37.184,139.8386",
      "福島県7"=>"37.184,140.2886",
      "福島県8"=>"37.184,140.7386",
      "福島県9"=>"37.634,139.3886",
      "福島県10"=>"37.634,139.8386",
      "福島県11"=>"37.634,140.2886",
      "福島県12"=>"37.634,140.7386",
      "福島県13"=>"38.084,139.3886",
      "福島県14"=>"38.084,139.8386",
      "福島県15"=>"38.084,140.2886",
      "福島県16"=>"38.084,140.7386",
      "福島県17"=>"38.534,139.3886",
      "福島県18"=>"38.534,139.8386",
      "福島県19"=>"38.534,140.2886",
      "福島県20"=>"38.534,140.7386",
      "福島県21"=>"38.984,139.3886",
      "福島県22"=>"38.984,139.8386",
      "福島県23"=>"38.984,140.2886",
      "福島県24"=>"38.984,140.7386",
      "茨城県1"=>"35.893,139.5480",
      "茨城県2"=>"35.893,139.9980",
      "茨城県3"=>"35.893,140.4480",
      "茨城県4"=>"36.343,139.5480",
      "茨城県5"=>"36.343,139.9980",
      "茨城県6"=>"36.343,140.4480",
      "茨城県7"=>"36.793,139.5480",
      "茨城県8"=>"36.793,139.9980",
      "茨城県9"=>"36.793,140.4480",
      "栃木県1"=>"36.177,139.4140",
      "栃木県2"=>"36.177,139.8640",
      "栃木県3"=>"36.177,140.3140",
      "栃木県4"=>"36.627,139.4140",
      "栃木県5"=>"36.627,139.8640",
      "栃木県6"=>"36.627,140.3140",
      "栃木県7"=>"37.077,139.4140",
      "栃木県8"=>"37.077,139.8640",
      "栃木県9"=>"37.077,140.3140",
      "群馬県1"=>"36.028,138.6010",
      "群馬県2"=>"36.028,139.0510",
      "群馬県3"=>"36.478,138.6010",
      "群馬県4"=>"36.478,139.0510",
      "群馬県5"=>"36.928,138.6010",
      "群馬県6"=>"36.928,139.0510",
      "埼玉県1"=>"35.542,138.7663",
      "埼玉県2"=>"35.542,139.2163",
      "埼玉県3"=>"35.542,139.6663",
      "埼玉県4"=>"35.992,138.7663",
      "埼玉県5"=>"35.992,139.2163",
      "埼玉県6"=>"35.992,139.6663",
      "千葉県1"=>"34.923,139.8821",
      "千葉県2"=>"34.923,140.3321",
      "千葉県3"=>"34.923,140.7821",
      "千葉県4"=>"35.373,139.8821",
      "千葉県5"=>"35.373,140.3321",
      "千葉県6"=>"35.373,140.7821",
      "千葉県7"=>"35.823,139.8821",
      "千葉県8"=>"35.823,140.3321",
      "千葉県9"=>"35.823,140.7821",
      "東京都1"=>"35.527,138.9886",
      "東京都2"=>"35.527,139.4386",
      "東京都3"=>"35.527,139.8886",
      "神奈川県1"=>"35.191,138.9071",
      "神奈川県2"=>"35.191,139.3571",
      "神奈川県3"=>"35.191,139.8071",
      "新潟県1"=>"37.152,138.2381",
      "新潟県2"=>"37.152,138.6881",
      "新潟県3"=>"37.152,139.1381",
      "新潟県4"=>"37.152,139.5881",
      "新潟県5"=>"37.602,138.2381",
      "新潟県6"=>"37.602,138.6881",
      "新潟県7"=>"37.602,139.1381",
      "新潟県8"=>"37.602,139.5881",
      "新潟県9"=>"38.052,138.2381",
      "新潟県10"=>"38.052,138.6881",
      "新潟県11"=>"38.052,139.1381",
      "新潟県12"=>"38.052,139.5881",
      "新潟県13"=>"38.502,138.2381",
      "新潟県14"=>"38.502,138.6881",
      "新潟県15"=>"38.502,139.1381",
      "新潟県16"=>"38.502,139.5881",
      "富山県1"=>"36.380,136.7270",
      "富山県2"=>"36.380,137.1770",
      "富山県3"=>"36.380,137.6270",
      "富山県4"=>"36.830,136.7270",
      "富山県5"=>"36.830,137.1770",
      "富山県6"=>"36.830,137.6270",
      "石川県1"=>"36.019,136.0510",
      "石川県2"=>"36.019,136.5010",
      "石川県3"=>"36.019,136.9510",
      "石川県4"=>"36.019,137.4010",
      "石川県5"=>"36.469,136.0510",
      "石川県6"=>"36.469,136.5010",
      "石川県7"=>"36.469,136.9510",
      "石川県8"=>"36.469,137.4010",
      "石川県9"=>"36.919,136.0510",
      "石川県10"=>"36.919,136.5010",
      "石川県11"=>"36.919,136.9510",
      "石川県12"=>"36.919,137.4010",
      "福井県1"=>"35.349,135.5171",
      "福井県2"=>"35.349,135.9671",
      "福井県3"=>"35.349,136.4171",
      "福井県4"=>"35.799,135.5171",
      "福井県5"=>"35.799,135.9671",
      "福井県6"=>"35.799,136.4171",
      "福井県7"=>"36.249,135.5171",
      "福井県8"=>"36.249,135.9671",
      "福井県9"=>"36.249,136.4171",
      "山梨県1"=>"35.290,138.1180",
      "山梨県2"=>"35.290,138.5680",
      "山梨県3"=>"35.290,139.0180",
      "山梨県4"=>"35.740,138.1180",
      "山梨県5"=>"35.740,138.5680",
      "山梨県6"=>"35.740,139.0180",
      "長野県1"=>"35.169,137.5210",
      "長野県2"=>"35.169,137.9710",
      "長野県3"=>"35.169,138.4210",
      "長野県4"=>"35.169,138.8710",
      "長野県5"=>"35.619,137.5210",
      "長野県6"=>"35.619,137.9710",
      "長野県7"=>"35.619,138.4210",
      "長野県8"=>"35.619,138.8710",
      "長野県9"=>"36.069,137.5210",
      "長野県10"=>"36.069,137.9710",
      "長野県11"=>"36.069,138.4210",
      "長野県12"=>"36.069,138.8710",
      "長野県13"=>"36.519,137.5210",
      "長野県14"=>"36.519,137.9710",
      "長野県15"=>"36.519,138.4210",
      "長野県16"=>"36.519,138.8710",
      "長野県17"=>"36.969,137.5210",
      "長野県18"=>"36.969,137.9710",
      "長野県19"=>"36.969,138.4210",
      "長野県20"=>"36.969,138.8710",
      "岐阜県1"=>"35.004,136.1033",
      "岐阜県2"=>"35.004,136.5533",
      "岐阜県3"=>"35.004,137.0033",
      "岐阜県4"=>"35.004,137.4533",
      "岐阜県5"=>"35.454,136.1033",
      "岐阜県6"=>"35.454,136.5533",
      "岐阜県7"=>"35.454,137.0033",
      "岐阜県8"=>"35.454,137.4533",
      "岐阜県9"=>"35.904,136.1033",
      "岐阜県10"=>"35.904,136.5533",
      "岐阜県11"=>"35.904,137.0033",
      "岐阜県12"=>"35.904,137.4533",
      "岐阜県13"=>"36.354,136.1033",
      "岐阜県14"=>"36.354,136.5533",
      "岐阜県15"=>"36.354,137.0033",
      "岐阜県16"=>"36.354,137.4533",
      "静岡県1"=>"34.382,137.4920",
      "静岡県2"=>"34.382,137.9420",
      "静岡県3"=>"34.382,138.3920",
      "静岡県4"=>"34.382,138.8420",
      "静岡県5"=>"34.832,137.4920",
      "静岡県6"=>"34.832,137.9420",
      "静岡県7"=>"34.832,138.3920",
      "静岡県8"=>"34.832,138.8420",
      "静岡県9"=>"35.282,137.4920",
      "静岡県10"=>"35.282,137.9420",
      "静岡県11"=>"35.282,138.3920",
      "静岡県12"=>"35.282,138.8420",
      "愛知県1"=>"34.597,36.69630",
      "愛知県2"=>"34.597,37.14630",
      "愛知県3"=>"34.597,37.59630",
      "愛知県4"=>"35.047,36.69630",
      "愛知県5"=>"35.047,37.14630",
      "愛知県6"=>"35.047,37.59630",
      "三重県1"=>"33.877,136.0660",
      "三重県2"=>"33.877,136.5160",
      "三重県3"=>"33.877,136.9660",
      "三重県4"=>"33.877,137.4160",
      "三重県5"=>"34.327,136.0660",
      "三重県6"=>"34.327,136.5160",
      "三重県7"=>"34.327,136.9660",
      "三重県8"=>"34.327,137.4160",
      "三重県9"=>"34.777,136.0660",
      "三重県10"=>"34.777,136.5160",
      "三重県11"=>"34.777,136.9660",
      "三重県12"=>"34.777,137.4160",
      "滋賀県1"=>"34.837,135.6352",
      "滋賀県2"=>"34.837,136.0852",
      "滋賀県3"=>"35.287,135.6352",
      "滋賀県4"=>"35.287,136.0852",
      "滋賀県5"=>"35.737,135.6352",
      "滋賀県6"=>"35.737,136.0852",
      "京都府1"=>"34.696,135.0021",
      "京都府2"=>"34.696,135.4521",
      "京都府3"=>"34.696,135.9021",
      "京都府4"=>"35.146,135.0021",
      "京都府5"=>"35.146,135.4521",
      "京都府6"=>"35.146,135.9021",
      "京都府7"=>"35.596,135.0021",
      "京都府8"=>"35.596,135.4521",
      "京都府9"=>"35.596,135.9021",
      "大阪府1"=>"34.307,135.2130",
      "大阪府2"=>"34.307,135.6630",
      "大阪府3"=>"34.757,135.2130",
      "大阪府4"=>"34.757,135.6630",
      "兵庫県1"=>"34.141,134.5700",
      "兵庫県2"=>"34.141,135.0200",
      "兵庫県3"=>"34.141,135.4700",
      "兵庫県4"=>"34.141,135.9200",
      "兵庫県5"=>"34.591,134.5700",
      "兵庫県6"=>"34.591,135.0200",
      "兵庫県7"=>"34.591,135.4700",
      "兵庫県8"=>"34.591,135.9200",
      "兵庫県9"=>"35.041,134.5700",
      "兵庫県10"=>"35.041,135.0200",
      "兵庫県11"=>"35.041,135.4700",
      "兵庫県12"=>"35.041,135.9200",
      "兵庫県13"=>"35.491,134.5700",
      "兵庫県14"=>"35.491,135.0200",
      "兵庫県15"=>"35.491,135.4700",
      "兵庫県16"=>"35.491,135.9200",
      "奈良県1"=>"34.191,135.4583",
      "奈良県2"=>"34.191,135.9083",
      "奈良県3"=>"34.641,135.4583",
      "奈良県4"=>"34.641,135.9083",
      "和歌山県1"=>"33.566,135.0512",
      "和歌山県2"=>"33.566,135.5012",
      "和歌山県3"=>"33.566,135.9512",
      "和歌山県4"=>"34.016,135.0512",
      "和歌山県5"=>"34.016,135.5012",
      "和歌山県6"=>"34.016,135.9512",
      "鳥取県1"=>"35.240,133.9133",
      "鳥取県2"=>"35.240,134.3633",
      "鳥取県3"=>"35.690,133.9133",
      "鳥取県4"=>"35.690,134.3633",
      "鳥取県5"=>"34.917,132.0411",
      "鳥取県6"=>"34.917,132.4911",
      "鳥取県7"=>"34.917,132.9411",
      "鳥取県8"=>"34.917,133.3911",
      "鳥取県9"=>"35.367,132.0411",
      "鳥取県10"=>"35.367,132.4911",
      "鳥取県11"=>"35.367,132.9411",
      "鳥取県12"=>"35.367,133.3911",
      "鳥取県13"=>"35.817,132.0411",
      "鳥取県14"=>"35.817,132.4911",
      "鳥取県15"=>"35.817,132.9411",
      "鳥取県16"=>"35.817,133.3911",
      "岡山県1"=>"34.370,133.2873",
      "岡山県2"=>"34.370,133.7373",
      "岡山県3"=>"34.370,134.1873",
      "岡山県4"=>"34.820,133.2873",
      "岡山県5"=>"34.820,133.7373",
      "岡山県6"=>"34.820,134.1873",
      "岡山県7"=>"35.270,133.2873",
      "岡山県8"=>"35.270,133.7373",
      "岡山県9"=>"35.270,134.1873",
      "広島県1"=>"34.024,132.0710",
      "広島県2"=>"34.024,132.5210",
      "広島県3"=>"34.024,132.9710",
      "広島県4"=>"34.024,133.4210",
      "広島県5"=>"34.474,132.0710",
      "広島県6"=>"34.474,132.5210",
      "広島県7"=>"34.474,132.9710",
      "広島県8"=>"34.474,133.4210",
      "広島県9"=>"34.924,132.0710",
      "広島県10"=>"34.924,132.5210",
      "広島県11"=>"34.924,132.9710",
      "広島県12"=>"34.924,133.4210",
      "山口県1"=>"33.936,130.7782",
      "山口県2"=>"33.936,131.2282",
      "山口県3"=>"33.936,131.6782",
      "山口県4"=>"33.936,132.1282",
      "山口県5"=>"34.386,130.7782",
      "山口県6"=>"34.386,131.2282",
      "山口県7"=>"34.386,131.6782",
      "山口県8"=>"34.386,132.1282",
      "徳島県1"=>"33.551,134.1571",
      "徳島県2"=>"33.551,134.6071",
      "徳島県3"=>"34.001,134.1571",
      "徳島県4"=>"34.001,134.6071",
      "香川県1"=>"34.061,133.4272",
      "香川県2"=>"34.061,133.8772",
      "愛媛県1"=>"33.069,132.0121",
      "愛媛県2"=>"33.069,132.4621",
      "愛媛県3"=>"33.069,132.9121",
      "愛媛県4"=>"33.069,133.3621",
      "愛媛県5"=>"33.519,132.0121",
      "愛媛県6"=>"33.519,132.4621",
      "愛媛県7"=>"33.519,132.9121",
      "愛媛県8"=>"33.519,133.3621",
      "愛媛県9"=>"33.969,132.0121",
      "愛媛県10"=>"33.969,132.4621",
      "愛媛県11"=>"33.969,132.9121",
      "愛媛県12"=>"33.969,133.3621",
      "高知県1"=>"32.739,132.6711",
      "高知県2"=>"32.739,133.1211",
      "高知県3"=>"32.739,133.5711",
      "高知県4"=>"32.739,134.0211",
      "高知県5"=>"33.189,132.6711",
      "高知県6"=>"33.189,133.1211",
      "高知県7"=>"33.189,133.5711",
      "高知県8"=>"33.189,134.0211",
      "高知県9"=>"33.639,132.6711",
      "高知県10"=>"33.639,133.1211",
      "高知県11"=>"33.639,133.5711",
      "高知県12"=>"33.639,134.0211",
      "福岡県1"=>"33.200,129.5761",
      "福岡県2"=>"33.200,130.0261",
      "福岡県3"=>"33.200,130.4761",
      "福岡県4"=>"33.200,130.9261",
      "福岡県5"=>"33.650,129.5761",
      "福岡県6"=>"33.650,130.0261",
      "福岡県7"=>"33.650,130.4761",
      "福岡県8"=>"33.650,130.9261",
      "福岡県9"=>"34.100,129.5761",
      "福岡県10"=>"34.100,130.0261",
      "福岡県11"=>"34.100,130.4761",
      "福岡県12"=>"34.100,130.9261",
      "福岡県13"=>"34.550,129.5761",
      "福岡県14"=>"34.550,130.0261",
      "福岡県15"=>"34.550,130.4761",
      "福岡県16"=>"34.550,130.9261",
      "佐賀県1"=>"33.066,129.7111",
      "佐賀県2"=>"33.066,130.1611",
      "長崎県1"=>"32.400,128.1153",
      "長崎県2"=>"32.400,128.5653",
      "長崎県3"=>"32.400,129.0153",
      "長崎県4"=>"32.400,129.4653",
      "長崎県5"=>"32.400,129.9153",
      "長崎県6"=>"32.850,128.1153",
      "長崎県7"=>"32.850,128.5653",
      "長崎県8"=>"32.850,129.0153",
      "長崎県9"=>"32.850,129.4653",
      "長崎県10"=>"32.850,129.9153",
      "長崎県11"=>"33.300,128.1153",
      "長崎県12"=>"33.300,128.5653",
      "長崎県13"=>"33.300,129.0153",
      "長崎県14"=>"33.300,129.4653",
      "長崎県15"=>"33.300,129.9153",
      "熊本県1"=>"32.034,129.0111",
      "熊本県2"=>"32.034,129.4611",
      "熊本県3"=>"32.034,129.9111",
      "熊本県4"=>"32.034,130.3611",
      "熊本県5"=>"32.034,130.8111",
      "熊本県6"=>"32.484,129.0111",
      "熊本県7"=>"32.484,129.4611",
      "熊本県8"=>"32.484,129.9111",
      "熊本県9"=>"32.484,130.3611",
      "熊本県10"=>"32.484,130.8111",
      "熊本県11"=>"32.934,129.0111",
      "熊本県12"=>"32.934,129.4611",
      "熊本県13"=>"32.934,129.9111",
      "熊本県14"=>"32.934,130.3611",
      "熊本県15"=>"32.934,130.8111",
      "大分県1"=>"32.677,130.6001",
      "大分県2"=>"32.677,131.0501",
      "大分県3"=>"32.677,131.5001",
      "大分県4"=>"32.677,131.9501",
      "大分県5"=>"33.127,130.6001",
      "大分県6"=>"33.127,131.0501",
      "大分県7"=>"33.127,131.5001",
      "大分県8"=>"33.127,131.9501",
      "大分県9"=>"33.577,130.6001",
      "大分県10"=>"33.577,131.0501",
      "大分県11"=>"33.577,131.5001",
      "大分県12"=>"33.577,131.9501",
      "宮崎県1"=>"31.277,130.5761",
      "宮崎県2"=>"31.277,131.0261",
      "宮崎県3"=>"31.277,131.4761",
      "宮崎県4"=>"31.727,130.5761",
      "宮崎県5"=>"31.727,131.0261",
      "宮崎県6"=>"31.727,131.4761",
      "宮崎県7"=>"32.177,130.5761",
      "宮崎県8"=>"32.177,131.0261",
      "宮崎県9"=>"32.177,131.4761",
      "宮崎県10"=>"32.627,130.5761",
      "宮崎県11"=>"32.627,131.0261",
      "宮崎県12"=>"32.627,131.4761",
      "鹿児島県1"=>"30.332,129.2241",
      "鹿児島県2"=>"30.332,129.6741",
      "鹿児島県3"=>"30.332,130.1241",
      "鹿児島県4"=>"30.332,130.5741",
      "鹿児島県5"=>"30.782,129.2241",
      "鹿児島県6"=>"30.782,129.6741",
      "鹿児島県7"=>"30.782,130.1241",
      "鹿児島県8"=>"30.782,130.5741",
      "鹿児島県9"=>"31.232,129.2241",
      "鹿児島県10"=>"31.232,129.6741",
      "鹿児島県11"=>"31.232,130.1241",
      "鹿児島県12"=>"31.232,130.5741",
      "鹿児島県13"=>"31.682,129.2241",
      "鹿児島県14"=>"31.682,129.6741",
      "鹿児島県15"=>"31.682,130.1241",
      "鹿児島県16"=>"31.682,130.5741",
      "沖縄県1"=>"24.287,122.9332",
      "沖縄県2"=>"24.287,123.3832",
      "沖縄県3"=>"24.287,123.8332",
      "沖縄県4"=>"24.287,124.2832",
      "沖縄県5"=>"24.287,124.7332",
      "沖縄県6"=>"24.287,125.1832",
      "沖縄県7"=>"24.287,125.6332",
      "沖縄県8"=>"24.287,126.0832",
      "沖縄県9"=>"24.287,126.5332",
      "沖縄県10"=>"24.287,126.9832",
      "沖縄県11"=>"24.287,127.4332",
      "沖縄県12"=>"24.287,127.8832",
      "沖縄県13"=>"24.737,122.9332",
      "沖縄県14"=>"24.737,123.3832",
      "沖縄県15"=>"24.737,123.8332",
      "沖縄県16"=>"24.737,124.2832",
      "沖縄県17"=>"24.737,124.7332",
      "沖縄県18"=>"24.737,125.1832",
      "沖縄県19"=>"24.737,125.6332",
      "沖縄県20"=>"24.737,126.0832",
      "沖縄県21"=>"24.737,126.5332",
      "沖縄県22"=>"24.737,126.9832",
      "沖縄県23"=>"24.737,127.4332",
      "沖縄県24"=>"24.737,127.8832",
      "沖縄県25"=>"25.187,122.9332",
      "沖縄県26"=>"25.187,123.3832",
      "沖縄県27"=>"25.187,123.8332",
      "沖縄県28"=>"25.187,124.2832",
      "沖縄県29"=>"25.187,124.7332",
      "沖縄県30"=>"25.187,125.1832",
      "沖縄県31"=>"25.187,125.6332",
      "沖縄県32"=>"25.187,126.0832",
      "沖縄県33"=>"25.187,126.5332",
      "沖縄県34"=>"25.187,126.9832",
      "沖縄県35"=>"25.187,127.4332",
      "沖縄県36"=>"25.187,127.8832",
      "沖縄県37"=>"25.637,122.9332",
      "沖縄県38"=>"25.637,123.3832",
      "沖縄県39"=>"25.637,123.8332",
      "沖縄県40"=>"25.637,124.2832",
      "沖縄県41"=>"25.637,124.7332",
      "沖縄県42"=>"25.637,125.1832",
      "沖縄県43"=>"25.637,125.6332",
      "沖縄県44"=>"25.637,126.0832",
      "沖縄県45"=>"25.637,126.5332",
      "沖縄県46"=>"25.637,126.9832",
      "沖縄県47"=>"25.637,127.4332",
      "沖縄県48"=>"25.637,127.8832",
      "沖縄県49"=>"26.087,122.9332",
      "沖縄県50"=>"26.087,123.3832",
      "沖縄県51"=>"26.087,123.8332",
      "沖縄県52"=>"26.087,124.2832",
      "沖縄県53"=>"26.087,124.7332",
      "沖縄県54"=>"26.087,125.1832",
      "沖縄県55"=>"26.087,125.6332",
      "沖縄県56"=>"26.087,126.0832",
      "沖縄県57"=>"26.087,126.5332",
      "沖縄県58"=>"26.087,126.9832",
      "沖縄県59"=>"26.087,127.4332",
      "沖縄県60"=>"26.087,127.8832",
      "沖縄県61"=>"26.537,122.9332",
      "沖縄県62"=>"26.537,123.3832",
      "沖縄県63"=>"26.537,123.8332",
      "沖縄県64"=>"26.537,124.2832",
      "沖縄県65"=>"26.537,124.7332",
      "沖縄県66"=>"26.537,125.1832",
      "沖縄県67"=>"26.537,125.6332",
      "沖縄県68"=>"26.537,126.0832",
      "沖縄県69"=>"26.537,126.5332",
      "沖縄県70"=>"26.537,126.9832",
      "沖縄県71"=>"26.537,127.4332",
      "沖縄県72"=>"26.537,127.8832"
    }

    PREFECTURES.each do |prefecture, location|
      puts "️ #{prefecture}のキャンプ場情報を取得中..."

      next_page_token = nil
      loop do
        uri = URI("https://places.googleapis.com/v1/places:searchText")
        http = Net::HTTP.new(uri.host, uri.port)
        http.use_ssl = true

        headers = {
          "Content-Type": "application/json",
          "X-Goog-Api-Key": api_key,
          "X-Goog-FieldMask": "places.displayName,places.formattedAddress,places.location,places.id",
          "Accept-Language": "ja-JP"
        }

        lat, lng = location.split(",")
        request_body = {
          "textQuery": "キャンプ場",
          "locationBias": {
            "circle": {
              "center": {
                "latitude": lat.to_f,
                "longitude": lng.to_f
              },
              "radius": 50000.0
            }
          },
          "pageToken": next_page_token,
          "includedType": "campground",
          "languageCode": "ja"
        }.compact.to_json

        response = http.post(uri.path, request_body, headers)

        unless response.is_a?(Net::HTTPSuccess)
          puts "⚠️ APIリクエストに失敗しました (#{response.code} #{response.message})"
          break
        end

        results = JSON.parse(response.body)["places"]

        ActiveRecord::Base.transaction do
          results.each do |place|
            begin
              campsite = Campsite.find_or_initialize_by(name: place["displayName"]["text"])
              campsite.address = place["formattedAddress"]
              campsite.latitude = place["location"]["latitude"]
              campsite.longitude = place["location"]["longitude"]

              place_id = place["id"]
              photo_paths = fetch_and_save_photos(place_id, api_key)

              # 取得したphoto_pathsをデータベースに保存
              campsite.photo_paths = photo_paths.any? ? photo_paths.to_json : nil

              begin
                campsite.save!
              rescue => e
                puts "❌ キャンプ場の保存に失敗: #{e.message}"
              end
            rescue StandardError => e
              Rails.logger.error "キャンプ場保存エラー: #{e.message}, place_id: #{place_id}"
              raise ActiveRecord::Rollback # トランザクションをロールバック
            end
          end
        end

        next_page_token = JSON.parse(response.body)["nextPageToken"]
        sleep 2 if next_page_token
        break unless next_page_token
        sleep 3
      end
    end

    puts "✅ 全てのキャンプ場データの取得＆保存が完了しました！"
  end
end

def fetch_and_save_photos(place_id, api_key)
  uri = URI("https://places.googleapis.com/v1/places/#{place_id}")
  http = Net::HTTP.new(uri.host, uri.port)
  http.use_ssl = true

  headers = {
    "Content-Type": "application/json",
    "X-Goog-Api-Key": api_key,
    "X-Goog-FieldMask": "photos"
  }

  response = http.get(uri, headers)

  unless response.is_a?(Net::HTTPSuccess)
    puts "⚠️ 写真取得APIエラー: #{response.code} #{response.message}, place_id: #{place_id}"
    Rails.logger.error "写真取得APIエラー: #{response.code} #{response.message}, place_id: #{place_id}"
    return []
  end

  details = JSON.parse(response.body)

  if details["photos"].nil?
    puts "⚠️ 写真データなし: place_id: #{place_id}"
    Rails.logger.warn "写真データなし: place_id: #{place_id}"
    return []
  end

  photos = details["photos"].map { |photo| photo["name"] }
  photo_paths = []

  storage_dir = Rails.root.join("public", "storage", "campsite_photos")
  FileUtils.mkdir_p(storage_dir) unless Dir.exist?(storage_dir)

  photos.first(4).each_with_index do |photo_reference, index|
    begin
      # `photo_url` をここで定義する
      photo_url = "https://places.googleapis.com/v1/#{photo_reference}/media?maxHeightPx=400&maxWidthPx=400&key=#{api_key}"
      filename = "campsite_#{place_id}_#{index}.jpg"
      file_path = storage_dir.join(filename)

      File.open(file_path, "wb") do |file|
        file.write(URI.open(photo_url).read)
      end

      photo_paths << "storage/campsite_photos/#{filename}"
    rescue => e
      puts "⚠️ 画像保存エラー: #{e.message}, place_id: #{place_id}"
      puts "⚠️ 画像保存エラー: #{e.message}, photo_url: #{photo_url}"
      Rails.logger.error "画像保存エラー: #{e.message}, place_id: #{place_id}, photo_url: #{photo_url}"
    end
  end

  photo_paths
end
